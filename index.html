<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‡æ ¡äº’è”æ•™ç»ƒç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="ai-integration.js"></script>
    <style>
        .card {
            @apply bg-white rounded-lg shadow-md border border-gray-200 p-6;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200;
        }
        .btn-secondary {
            @apply bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition-colors duration-200;
        }
        .input-field {
            @apply w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent;
        }
    </style>
    <!-- Firebase App (æ ¸å¿ƒ) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<!-- Firebase Database -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
  // ä½ çš„ firebaseConfig
  const firebaseConfig = {
    apiKey: "AIzaSyCECwMZOu2iMfmm4wMAWwMdDEjW8Pu3Bdg",
    authDomain: "waanxiaohulian.firebaseapp.com",
    databaseURL: "https://waanxiaohulian-default-rtdb.firebaseio.com",
    projectId: "waanxiaohulian",
    storageBucket: "waanxiaohulian.firebasestorage.app",
    messagingSenderId: "793340262715",
    appId: "1:793340262715:web:f67e9879b7ee05a2d15f1e",
    measurementId: "G-11Z6XV1QF2"
  };
  // åˆå§‹åŒ–
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
</script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- ç™»å½•/æ³¨å†Œç•Œé¢ -->
    <div id="auth-container" style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:#f8fafc;position:fixed;z-index:100;width:100vw;height:100vh;top:0;left:0;">
      <div style="background:white;padding:2.5rem 2rem;border-radius:1rem;box-shadow:0 4px 32px #0001;min-width:320px;max-width:90vw;">
        <h2 id="auth-title" style="font-size:1.5rem;font-weight:600;text-align:center;margin-bottom:1.5rem;color:#2563eb;">ç™»å½•</h2>
        <form id="auth-form">
          <input id="auth-phone" type="tel" pattern="[0-9]{11}" placeholder="æ‰‹æœºå·" required style="width:100%;margin-bottom:1rem;padding:0.75rem;border-radius:0.5rem;border:1px solid #d1d5db;outline:none;font-size:1rem;">
          <input id="auth-password" type="password" placeholder="å¯†ç " required style="width:100%;margin-bottom:1.5rem;padding:0.75rem;border-radius:0.5rem;border:1px solid #d1d5db;outline:none;font-size:1rem;">
          <button id="auth-submit" type="submit" style="width:100%;background:#2563eb;color:white;font-weight:600;padding:0.75rem;border:none;border-radius:0.5rem;font-size:1rem;">ç™»å½•</button>
        </form>
        <div style="text-align:center;margin-top:1rem;">
          <span id="auth-toggle-text">æ²¡æœ‰è´¦å·ï¼Ÿ</span>
          <a href="#" id="auth-toggle-link" style="color:#2563eb;text-decoration:underline;">æ³¨å†Œ</a>
        </div>
        <div id="auth-error" style="color:#ef4444;text-align:center;margin-top:1rem;display:none;"></div>
      </div>
    </div>
    <!-- é¡¶éƒ¨å¯¼èˆªæ ï¼ˆç™»å½•åæ˜¾ç¤ºï¼‰ -->
    <nav id="main-navbar" style="display:none;position:sticky;top:0;z-index:40;background:#2563eb;color:#fff;box-shadow:0 2px 8px #0001;">
      <div style="max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:0.5rem 2rem;">
        <div style="display:flex;align-items:center;gap:2rem;">
          <span style="font-weight:700;font-size:1.2rem;letter-spacing:1px;">ä¸‡æ ¡äº’è”æ•™ç»ƒç³»ç»Ÿ</span>
          <button class="nav-btn" data-tab="dashboard" style="background:none;border:none;color:inherit;font-size:1rem;padding:0.5rem 1rem;cursor:pointer;">ä»ªè¡¨ç›˜</button>
          <button class="nav-btn" data-tab="students" style="background:none;border:none;color:inherit;font-size:1rem;padding:0.5rem 1rem;cursor:pointer;">å­¦ç”Ÿç®¡ç†</button>
          <button class="nav-btn" data-tab="schedule" style="background:none;border:none;color:inherit;font-size:1rem;padding:0.5rem 1rem;cursor:pointer;">è¯¾ç¨‹å®‰æ’</button>
          <button class="nav-btn" data-tab="completed" style="background:none;border:none;color:inherit;font-size:1rem;padding:0.5rem 1rem;cursor:pointer;">å·²å®Œæˆè¯¾ç¨‹</button>
          <button class="nav-btn" data-tab="feedback" style="background:none;border:none;color:inherit;font-size:1rem;padding:0.5rem 1rem;cursor:pointer;">AIåé¦ˆ</button>
        </div>
        <div id="navbar-user-bar" style="display:none;align-items:center;gap:1.2rem;">
          <span id="navbar-user-phone" style="color:#fff;font-weight:500;font-size:1rem;padding:0 0.5rem;"></span>
          <button id="navbar-logout-btn" style="background:transparent;color:#fff;border:1.5px solid #fff;border-radius:1.2rem;padding:0.25rem 1.2rem;font-size:1rem;cursor:pointer;transition:background 0.2s, color 0.2s;">é€€å‡ºç™»å½•</button>
        </div>
      </div>
    </nav>

    <script>
              // åˆ‡æ¢ä¸»å†…å®¹åŒº
        function showTab(tab) {
          const tabIds = ['dashboard','students','schedule','completed','feedback'];
          tabIds.forEach(id => {
            const el = document.getElementById(id+'-content');
            if (el) el.style.display = (id===tab) ? 'block' : 'none';
          });
          // é«˜äº®å¯¼èˆªæŒ‰é’®
          document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.style.background = btn.dataset.tab===tab ? '#1e40af' : 'none';
          });
        }
      // å¯¼èˆªæ äº‹ä»¶
      document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.nav-btn').forEach(btn => {
          btn.onclick = function() {
            showTab(btn.dataset.tab);
          };
        });
      });
      // ç™»å½•åæ˜¾ç¤ºå¯¼èˆªæ å’Œé»˜è®¤tab
      function showMainContent(phone) {
        document.getElementById('auth-container').style.display = 'none';
        document.getElementById('navbar-user-bar').style.display = 'flex';
        document.getElementById('navbar-user-phone').textContent = phone;
        document.getElementById('main-navbar').style.display = '';
        document.body.classList.remove('auth-locked');
        
        // ç¡®ä¿æ‰€æœ‰å†…å®¹åŒºåŸŸéšè—ï¼Œç„¶åæ˜¾ç¤ºä»ªè¡¨æ¿
        document.querySelectorAll('.tab-content').forEach(content => {
          content.style.display = 'none';
        });
        showTab('dashboard'); // é»˜è®¤æ˜¾ç¤ºä»ªè¡¨ç›˜
      }
      // é€€å‡ºç™»å½•æ—¶éšè—å¯¼èˆªæ 
      function logout() {
        localStorage.removeItem('loginPhone');
        document.getElementById('auth-container').style.display = 'flex';
        document.getElementById('navbar-user-bar').style.display = 'none';
        document.getElementById('main-navbar').style.display = 'none';
        document.body.classList.add('auth-locked');
      }
      
      // ç»‘å®šé€€å‡ºç™»å½•äº‹ä»¶
      document.addEventListener('DOMContentLoaded', function() {
        const logoutBtn = document.getElementById('logout-btn');
        const navbarLogoutBtn = document.getElementById('navbar-logout-btn');
        
        if (logoutBtn) {
          logoutBtn.onclick = logout;
        }
        if (navbarLogoutBtn) {
          navbarLogoutBtn.onclick = logout;
        }
      });
      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹ç™»å½•çŠ¶æ€
      window.addEventListener('DOMContentLoaded', function() {
        const phone = localStorage.getItem('loginPhone');
        if (phone) {
          showMainContent(phone);
        } else {
          document.getElementById('auth-container').style.display = 'flex';
          document.getElementById('navbar-user-bar').style.display = 'none';
          document.getElementById('main-navbar').style.display = 'none';
          document.body.classList.add('auth-locked');
        }
      });
    </script>

    <!-- ä¸»è¦å†…å®¹ -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- å†…å®¹åŒºåŸŸ -->
        <div id="content">
            <!-- ä»ªè¡¨æ¿ -->
            <div id="dashboard-content" class="tab-content active">
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900">ä»ªè¡¨æ¿</h2>
                    </div>
                    
                    <!-- ç»Ÿè®¡å¡ç‰‡ -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="card">
                            <div class="flex items-center">
                                <div class="p-3 rounded-lg bg-blue-50 text-blue-600">
                                    <i data-lucide="users" class="w-6 h-6"></i>
                                </div>
                                <div class="ml-4 flex-1">
                                    <p class="text-sm font-medium text-gray-600">æ€»å­¦ç”Ÿæ•°</p>
                                    <p class="text-2xl font-bold text-gray-900">0</p>
                                    <p class="text-sm text-gray-500 mt-1">æš‚æ— å­¦ç”Ÿ</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="flex items-center">
                                <div class="p-3 rounded-lg bg-green-50 text-green-600">
                                    <i data-lucide="users" class="w-6 h-6"></i>
                                </div>
                                <div class="ml-4 flex-1">
                                    <p class="text-sm font-medium text-gray-600">æ­£å¼å­¦å‘˜</p>
                                    <p class="text-2xl font-bold text-gray-900">0</p>
                                    <p class="text-sm text-gray-500 mt-1">æš‚æ— æ­£å¼å­¦å‘˜</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="flex items-center">
                                <div class="p-3 rounded-lg bg-yellow-50 text-yellow-600">
                                    <i data-lucide="book-open" class="w-6 h-6"></i>
                                </div>
                                <div class="ml-4 flex-1">
                                    <p class="text-sm font-medium text-gray-600">è¯•è¯¾å­¦å‘˜</p>
                                    <p class="text-2xl font-bold text-gray-900">0</p>
                                    <p class="text-sm text-gray-500 mt-1">æš‚æ— è¯•è¯¾å­¦å‘˜</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="flex items-center">
                                <div class="p-3 rounded-lg bg-purple-50 text-purple-600">
                                    <i data-lucide="dollar-sign" class="w-6 h-6"></i>
                                </div>
                                <div class="ml-4 flex-1">
                                    <p class="text-sm font-medium text-gray-600">æ€»è–ªèµ„</p>
                                    <p class="text-2xl font-bold text-gray-900">Â¥0.0</p>
                                    <p class="text-sm text-gray-500 mt-1">æš‚æ— æ”¶å…¥</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- æœ€è¿‘æ´»åŠ¨ -->
                        <div class="card">
                            <h3 class="text-xl font-semibold text-gray-900 mb-6">æœ€è¿‘æ´»åŠ¨</h3>
                            <div class="space-y-4">
                                <div class="text-center py-8">
                                    <i data-lucide="calendar" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                                    <p class="text-gray-500">æš‚æ— æœ€è¿‘æ´»åŠ¨</p>
                                    <p class="text-sm text-gray-400 mt-2">å¼€å§‹æ·»åŠ è¯¾ç¨‹å’Œå­¦ç”Ÿåï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºæœ€æ–°æ´»åŠ¨</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å³å°†åˆ°æ¥çš„è¯¾ç¨‹ -->
                        <div class="card">
                            <h3 class="text-xl font-semibold text-gray-900 mb-6">å³å°†åˆ°æ¥çš„è¯¾ç¨‹</h3>
                            <div class="text-center py-8">
                                <i data-lucide="clock" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                                <p class="text-gray-500">æš‚æ— å³å°†åˆ°æ¥çš„è¯¾ç¨‹</p>
                                <p class="text-sm text-gray-400 mt-2">æ·»åŠ è¯¾ç¨‹å®‰æ’åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºå³å°†åˆ°æ¥çš„è¯¾ç¨‹</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å­¦ç”Ÿç®¡ç† -->
            <div id="students-content" class="tab-content">
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900">å­¦ç”Ÿç®¡ç†</h2>
                        <button class="btn-primary flex items-center gap-2" onclick="showAddStudentModal()">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            æ·»åŠ å­¦ç”Ÿ
                        </button>
                    </div>
                    
                    <div class="flex gap-4 mb-6">
                        <div class="flex-1 relative">
                            <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"></i>
                            <input type="text" placeholder="æœç´¢å­¦ç”Ÿå§“å..." class="input-field pl-10" onkeyup="filterStudents(this.value)">
                        </div>
                        <select class="input-field w-48" onchange="filterBySubject(this.value)">
                            <option value="">æ‰€æœ‰ç§‘ç›®</option>
                            <option value="è¯­æ–‡">è¯­æ–‡</option>
                            <option value="æ•°å­¦">æ•°å­¦</option>
                            <option value="è‹±è¯­">è‹±è¯­</option>
                            <option value="ç‰©ç†">ç‰©ç†</option>
                        </select>
                    </div>

                    <!-- æ­£å¼æˆå‘˜ -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
                            <i data-lucide="users" class="w-5 h-5 text-green-600"></i>
                            æ­£å¼æˆå‘˜
                        </h3>
                                                <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3" id="formal-students">
                            <!-- æ­£å¼å­¦å‘˜åˆ—è¡¨ä¼šåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>

                    <!-- è¯•è¯¾æˆå‘˜ -->
                    <div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
                            <i data-lucide="book-open" class="w-5 h-5 text-yellow-600"></i>
                            è¯•è¯¾æˆå‘˜
                        </h3>
                        <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3" id="trial-students">
                            <!-- è¯•è¯¾æˆå‘˜åˆ—è¡¨ä¼šåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- å·²å®Œæˆè¯¾ç¨‹ -->
            <div id="completed-content" class="tab-content">
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900">å·²å®Œæˆè¯¾ç¨‹</h2>
                        <div class="text-sm text-gray-600">
                            å…±å®Œæˆ <span id="completed-count">0</span> é—¨è¯¾ç¨‹
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b border-gray-200">
                                        <th class="text-left py-3 px-4 font-medium text-gray-700">å­¦å‘˜å§“å</th>
                                        <th class="text-left py-3 px-4 font-medium text-gray-700">ç§‘ç›®</th>
                                        <th class="text-left py-3 px-4 font-medium text-gray-700">å¹´çº§</th>
                                        <th class="text-left py-3 px-4 font-medium text-gray-700">è¯¾ç¨‹æ—¶é—´</th>
                                        <th class="text-left py-3 px-4 font-medium text-gray-700">å®Œæˆæ—¶é—´</th>
                                        <th class="text-left py-3 px-4 font-medium text-gray-700">ç±»å‹</th>
                                        <th class="text-left py-3 px-4 font-medium text-gray-700">è–ªèµ„</th>
                                    </tr>
                                </thead>
                                <tbody id="completed-courses-list">
                                    <!-- å·²å®Œæˆè¯¾ç¨‹åˆ—è¡¨ä¼šé€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¯¾ç¨‹å®‰æ’ -->
            <div id="schedule-content" class="tab-content">
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900">è¯¾ç¨‹å®‰æ’</h2>
                        <button class="btn-primary flex items-center gap-2" onclick="showAddScheduleModal()">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            å®‰æ’è¯¾ç¨‹
                        </button>
                    </div>
                    
                    <!-- è¯¾ç¨‹æ—¶é—´è¡¨ -->
                    <div class="card overflow-x-auto">
                        <div class="min-w-full">
                            <table class="w-full border-collapse text-xs">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="border border-gray-200 px-2 py-1 text-xs font-medium text-gray-700 w-16">æ—¶é—´</th>
                                        <th class="border border-gray-200 px-2 py-1 text-xs font-medium text-gray-700">å‘¨ä¸€</th>
                                        <th class="border border-gray-200 px-2 py-1 text-xs font-medium text-gray-700">å‘¨äºŒ</th>
                                        <th class="border border-gray-200 px-2 py-1 text-xs font-medium text-gray-700">å‘¨ä¸‰</th>
                                        <th class="border border-gray-200 px-2 py-1 text-xs font-medium text-gray-700">å‘¨å››</th>
                                        <th class="border border-gray-200 px-2 py-1 text-xs font-medium text-gray-700">å‘¨äº”</th>
                                        <th class="border border-gray-200 px-2 py-1 text-xs font-medium text-gray-700">å‘¨å…­</th>
                                        <th class="border border-gray-200 px-2 py-1 text-xs font-medium text-gray-700">å‘¨æ—¥</th>
                                    </tr>
                                </thead>
                                <tbody id="schedule-table-body">
                                    <!-- æ—¶é—´è¡Œä¼šé€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- å›¾ä¾‹è¯´æ˜ -->
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">å­¦å‘˜é¢œè‰²è¯´æ˜</h3>
                        <p class="text-sm text-gray-600 mb-4">æ¯ä¸ªå­¦å‘˜éƒ½æœ‰ç‹¬ç‰¹çš„é¢œè‰²æ ‡è¯†ï¼Œæ–¹ä¾¿åœ¨æ—¶é—´è¡¨ä¸­å¿«é€Ÿè¯†åˆ«ã€‚é¢œè‰²ä¼šæ ¹æ®å­¦å‘˜æ•°é‡è‡ªåŠ¨åˆ†é…ã€‚</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-pink-200 border border-pink-300 rounded"></div>
                                <span class="text-sm text-gray-600">å­¦å‘˜1</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-indigo-200 border border-indigo-300 rounded"></div>
                                <span class="text-sm text-gray-600">å­¦å‘˜2</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-teal-200 border border-teal-300 rounded"></div>
                                <span class="text-sm text-gray-600">å­¦å‘˜3</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-purple-200 border border-purple-300 rounded"></div>
                                <span class="text-sm text-gray-600">å­¦å‘˜4</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¯•å­¦æµç¨‹ç”Ÿæˆ -->
            <div id="trials-content" class="tab-content">
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900">è¯•å­¦æµç¨‹ç”Ÿæˆ</h2>
                    </div>
                    
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">è¯•è¯¾å­¦å‘˜åˆ—è¡¨</h3>
                        <div class="grid gap-4" id="trial-students-list">
                            <!-- è¯•è¯¾å­¦å‘˜åˆ—è¡¨ä¼šé€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¼´å­¦åé¦ˆ -->
            <div id="feedback-content" class="tab-content">
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900">ä¼´å­¦åé¦ˆ</h2>
                        <button onclick="showAddFeedbackModal()" class="btn-primary flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            æ·»åŠ åé¦ˆ
                        </button>
                    </div>
                    
                    <!-- AIæ™ºèƒ½åˆ†æé¢æ¿ -->
                    <div class="card bg-gradient-to-r from-blue-50 to-purple-50 border-blue-200">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="p-2 rounded-lg bg-blue-100">
                                    <i data-lucide="brain" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">AIæ™ºèƒ½åˆ†æ</h3>
                                    <p class="text-sm text-gray-600">åŸºäºå†å²æ•°æ®å’Œå­¦ä¹ è¡¨ç°ï¼ŒAIä¸ºæ‚¨æä¾›ä¸ªæ€§åŒ–å»ºè®®</p>
                                </div>
                            </div>
                            <button onclick="showAIConfigModal()" class="btn-secondary text-sm bg-purple-100 text-purple-700 hover:bg-purple-200">
                                <i data-lucide="settings" class="w-4 h-4"></i>
                                AIé…ç½®
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-white p-4 rounded-lg border">
                                <h4 class="font-medium text-gray-900 mb-2">å­¦ä¹ è¶‹åŠ¿</h4>
                                <p class="text-sm text-gray-600">æ•´ä½“å‘ˆä¸Šå‡è¶‹åŠ¿ï¼Œæ•°å­¦åŸºç¡€æ‰å®</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg border">
                                <h4 class="font-medium text-gray-900 mb-2">è–„å¼±ç¯èŠ‚</h4>
                                <p class="text-sm text-gray-600">åº”ç”¨é¢˜è§£é¢˜æ€è·¯éœ€è¦åŠ å¼º</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg border">
                                <h4 class="font-medium text-gray-900 mb-2">å»ºè®®é‡ç‚¹</h4>
                                <p class="text-sm text-gray-600">å¤šç»ƒä¹ å®é™…åº”ç”¨é¢˜ï¼ŒåŸ¹å…»è§£é¢˜æ€ç»´</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- åé¦ˆåˆ—è¡¨ -->
                    <div id="feedback-list" class="grid gap-4">
                        <div class="text-center py-12">
                            <i data-lucide="message-square" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">æš‚æ— åé¦ˆè®°å½•</h3>
                            <p class="text-gray-500 mb-4">å¼€å§‹æ·»åŠ ä¼´å­¦åé¦ˆåï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºåé¦ˆåˆ—è¡¨</p>
                            <button onclick="showAddFeedbackModal()" class="btn-primary">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                æ·»åŠ ç¬¬ä¸€ä¸ªåé¦ˆ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // åˆå§‹åŒ–å›¾æ ‡
        lucide.createIcons();

        // æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½ - å…¼å®¹é¡¶éƒ¨å¯¼èˆªæ 
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„å†…å®¹
            const targetContent = document.getElementById(tabName + '-content');
            if (targetContent) {
                targetContent.style.display = 'block';
            }
            
            // å¦‚æœåˆ‡æ¢åˆ°å·²å®Œæˆè¯¾ç¨‹é¡µé¢ï¼Œæ›´æ–°åˆ—è¡¨
            if (tabName === 'completed') {
                updateCompletedCoursesList();
            }
        }

        // æœç´¢å­¦ç”ŸåŠŸèƒ½
        function filterStudents(searchTerm) {
            const studentCards = document.querySelectorAll('.student-card');
            searchTerm = searchTerm.toLowerCase();
            
            studentCards.forEach(card => {
                const studentName = card.getAttribute('data-name').toLowerCase();
                if (studentName.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // æŒ‰ç§‘ç›®ç­›é€‰åŠŸèƒ½
        function filterBySubject(subject) {
            const studentCards = document.querySelectorAll('.student-card');
            
            studentCards.forEach(card => {
                const cardSubject = card.getAttribute('data-subject');
                if (subject === '' || cardSubject === subject) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // è¯•è¯¾æˆå‘˜è½¬ä¸ºæ­£å¼æˆå‘˜
        function convertToFormal(button) {
            const studentCard = button.closest('.student-card');
            const studentName = studentCard.getAttribute('data-name');
            const subject = studentCard.getAttribute('data-subject');
            
            // ç¡®è®¤è½¬æ¢
            if (confirm(`ç¡®å®šè¦å°† ${studentName} ä»è¯•è¯¾æˆå‘˜è½¬ä¸ºæ­£å¼æˆå‘˜å—ï¼Ÿ`)) {
                // ç§»é™¤è½¬æ¢æŒ‰é’®
                button.remove();
                
                // æ›´æ–°çŠ¶æ€æ ‡ç­¾
                const statusSpan = studentCard.querySelector('span');
                statusSpan.textContent = 'æ­£å¼å­¦å‘˜';
                statusSpan.className = 'px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
                
                // ç§»åŠ¨åˆ°æ­£å¼æˆå‘˜åŒºåŸŸ
                const formalStudentsContainer = document.getElementById('formal-students');
                formalStudentsContainer.appendChild(studentCard);
                
                // æ›´æ–°å­¦ç”Ÿæ•°æ®æ˜ å°„
                if (window.studentMap && window.studentMap[studentName]) {
                    window.studentMap[studentName].type = 'formal';
                }
                
                // æ›´æ–°ä»ªè¡¨æ¿ç»Ÿè®¡
                updateDashboardStats();
                
                // æ›´æ–°è¯¾ç¨‹å®‰æ’æ¨¡å—çš„å­¦ç”Ÿåˆ—è¡¨
                updateScheduleStudentOptions();
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showNotification(`${studentName} å·²æˆåŠŸè½¬ä¸ºæ­£å¼æˆå‘˜ï¼`, 'success');
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
        function showNotification(message, type = 'info') {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            let bgColor = 'bg-blue-500';
            
            if (type === 'success') {
                bgColor = 'bg-green-500';
            } else if (type === 'error') {
                bgColor = 'bg-red-500';
            }
            
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transition-all duration-300 ${bgColor} text-white`;
            notification.textContent = message;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(notification);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // æ˜¾ç¤ºæ·»åŠ å­¦ç”Ÿæ¨¡æ€æ¡†
        function showAddStudentModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 overflow-y-auto';
            modal.innerHTML = `
                <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                        <div class="absolute inset-0 bg-gray-500 opacity-75" onclick="closeModal()"></div>
                    </div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900">æ·»åŠ æ–°å­¦ç”Ÿ</h3>
                                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <form onsubmit="addNewStudent(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">å­¦å‘˜å§“å *</label>
                                        <input type="text" name="name" required class="input-field" placeholder="è¯·è¾“å…¥å­¦å‘˜å§“å">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">ç”µè¯ *</label>
                                        <input type="tel" name="phone" required class="input-field" placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">å¹´çº§ *</label>
                                        <select name="grade" required class="input-field">
                                            <option value="">è¯·é€‰æ‹©å¹´çº§</option>
                                            <option value="å°å­¦">å°å­¦</option>
                                            <option value="åˆä¸­">åˆä¸­</option>
                                            <option value="é«˜ä¸­">é«˜ä¸­</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">ç§‘ç›® *</label>
                                        <select name="subject" required class="input-field" onchange="toggleTrialTime(this.value)">
                                            <option value="">è¯·é€‰æ‹©ç§‘ç›®</option>
                                            <option value="è¯­æ–‡">è¯­æ–‡</option>
                                            <option value="æ•°å­¦">æ•°å­¦</option>
                                            <option value="è‹±è¯­">è‹±è¯­</option>
                                            <option value="ç‰©ç†">ç‰©ç†</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">å­¦å‘˜ç±»å‹ *</label>
                                        <select name="type" required class="input-field" onchange="toggleTrialTime(this.value)">
                                            <option value="">è¯·é€‰æ‹©ç±»å‹</option>
                                            <option value="trial">è¯•è¯¾å­¦å‘˜</option>
                                            <option value="formal">æ­£å¼å­¦å‘˜</option>
                                        </select>
                                    </div>
                                    <div id="trial-time-field" style="display: none;">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">è¯•è¯¾æ—¶é—´ *</label>
                                        <input type="datetime-local" name="trialTime" class="input-field">
                                    </div>
                                </div>
                                <div class="flex gap-3 mt-6">
                                    <button type="submit" class="btn-primary flex-1">æ·»åŠ å­¦ç”Ÿ</button>
                                    <button type="button" onclick="closeModal()" class="btn-secondary flex-1">å–æ¶ˆ</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            lucide.createIcons();
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            const modal = document.querySelector('.fixed.inset-0.z-50');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        // æ·»åŠ æ–°å­¦ç”Ÿ
        function addNewStudent(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const studentData = Object.fromEntries(formData);
            
            // åˆ›å»ºå­¦ç”Ÿå¡ç‰‡
            const studentCard = createStudentCard(studentData);
            
            // è®¾ç½®å¹´çº§å±æ€§
            studentCard.setAttribute('data-grade', studentData.grade);
            
            // æ ¹æ®ç±»å‹æ·»åŠ åˆ°å¯¹åº”åŒºåŸŸ
            if (studentData.type === 'trial') {
                document.getElementById('trial-students').appendChild(studentCard);
            } else {
                document.getElementById('formal-students').appendChild(studentCard);
            }
            
            // æ›´æ–°å­¦ç”Ÿæ•°æ®æ˜ å°„
            const studentMap = window.studentMap || {};
            studentMap[studentData.name] = { 
                subject: studentData.subject, 
                type: studentData.type,
                grade: studentData.grade 
            };
            window.studentMap = studentMap;
            
            // æ›´æ–°ä»ªè¡¨æ¿ç»Ÿè®¡
            updateDashboardStats();
            
            // æ›´æ–°è¯¾ç¨‹å®‰æ’æ¨¡å—çš„å­¦ç”Ÿåˆ—è¡¨
            updateScheduleStudentOptions();
            
            // å¦‚æœæ˜¯è¯•è¯¾å­¦å‘˜ï¼Œè‡ªåŠ¨æ·»åŠ åˆ°è¯¾ç¨‹å®‰æ’ä¸­
            if (studentData.type === 'trial' && studentData.trialTime) {
                addTrialCourseToSchedule(studentData);
            }
            
            // å…³é—­æ¨¡æ€æ¡†
            closeModal();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showNotification(`å­¦ç”Ÿ ${studentData.name} æ·»åŠ æˆåŠŸï¼`, 'success');
        }

        // åˆ é™¤å­¦ç”Ÿ
        function deleteStudent(button) {
            const studentCard = button.closest('.student-card');
            const studentName = studentCard.getAttribute('data-name');
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤å­¦å‘˜ ${studentName} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
                studentCard.remove();
                
                // ä»å­¦ç”Ÿæ•°æ®æ˜ å°„ä¸­åˆ é™¤
                if (window.studentMap && window.studentMap[studentName]) {
                    delete window.studentMap[studentName];
                }
                
                // æ›´æ–°ä»ªè¡¨æ¿ç»Ÿè®¡
                updateDashboardStats();
                
                // æ›´æ–°è¯¾ç¨‹å®‰æ’æ¨¡å—çš„å­¦ç”Ÿåˆ—è¡¨
                updateScheduleStudentOptions();
                
                showNotification(`å­¦å‘˜ ${studentName} å·²åˆ é™¤ï¼`, 'success');
            }
        }

        // æ›´æ–°ä»ªè¡¨æ¿ç»Ÿè®¡
        function updateDashboardStats() {
            const formalStudents = document.querySelectorAll('#formal-students .student-card').length;
            const trialStudents = document.querySelectorAll('#trial-students .student-card').length;
            const totalStudents = formalStudents + trialStudents;
            
            // æ›´æ–°æ€»å­¦ç”Ÿæ•°
            const totalStudentsElement = document.querySelector('.card:nth-child(1) .text-2xl');
            if (totalStudentsElement) {
                totalStudentsElement.textContent = totalStudents;
                const subtitle = totalStudentsElement.nextElementSibling;
                if (subtitle) {
                    subtitle.textContent = totalStudents > 0 ? `+${totalStudents} æœ¬æœˆæ–°å¢` : 'æš‚æ— å­¦ç”Ÿ';
                }
            }
            
            // æ›´æ–°æ­£å¼å­¦å‘˜æ•°
            const monthlyCoursesElement = document.querySelector('.card:nth-child(2) .text-2xl');
            if (monthlyCoursesElement) {
                monthlyCoursesElement.textContent = formalStudents;
                const subtitle = monthlyCoursesElement.nextElementSibling;
                if (subtitle) {
                    subtitle.textContent = formalStudents > 0 ? `${formalStudents} åå­¦å‘˜` : 'æš‚æ— æ­£å¼å­¦å‘˜';
                }
            }
            
            // æ›´æ–°è¯•è¯¾å­¦å‘˜æ•°
            const trialCoursesElement = document.querySelector('.card:nth-child(3) .text-2xl');
            if (trialCoursesElement) {
                trialCoursesElement.textContent = trialStudents;
                const subtitle = trialCoursesElement.nextElementSibling;
                if (subtitle) {
                    subtitle.textContent = trialStudents > 0 ? `${trialStudents} åå­¦å‘˜` : 'æš‚æ— è¯•è¯¾å­¦å‘˜';
                }
            }
            
            // æ›´æ–°æ€»è–ªèµ„
            const feedbackElement = document.querySelector('.card:nth-child(4) .text-2xl');
            if (feedbackElement) {
                const totalSalary = completedCourses.reduce((total, course) => {
                    return total + parseFloat(getCoursePrice(course));
                }, 0);
                feedbackElement.textContent = 'Â¥' + totalSalary.toFixed(1);
                const subtitle = feedbackElement.nextElementSibling;
                if (subtitle) {
                    subtitle.textContent = totalSalary > 0 ? `${totalSalary.toFixed(1)} å…ƒæ€»æ”¶å…¥` : 'æš‚æ— æ”¶å…¥';
                }
            }
        }

        // å°†è¯•è¯¾å­¦å‘˜è‡ªåŠ¨æ·»åŠ åˆ°è¯¾ç¨‹å®‰æ’
        function addTrialCourseToSchedule(studentData) {
            if (!studentData.trialTime) return;
            
            const trialDate = new Date(studentData.trialTime);
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const day = dayNames[trialDate.getDay()];
            const time = trialDate.getHours().toString().padStart(2, '0') + ':' + trialDate.getMinutes().toString().padStart(2, '0');
            
            const newCourse = {
                id: Date.now().toString(),
                studentName: studentData.name,
                subject: studentData.subject,
                day: day,
                time: time,
                duration: 60, // è¯•è¯¾é»˜è®¤60åˆ†é’Ÿ
                type: 'trial',
                status: 'scheduled'
            };
            
            // æ£€æŸ¥æ—¶é—´å†²çª
            const conflict = scheduleData.find(course => {
                if (course.day === day && course.status !== 'completed') {
                    const newStartHour = parseInt(time.split(':')[0]);
                    const newStartMinute = parseInt(time.split(':')[1]);
                    const newStartMinutes = newStartHour * 60 + newStartMinute;
                    const newEndMinutes = newStartMinutes + 60; // è¯•è¯¾60åˆ†é’Ÿ
                    
                    const existingStartHour = parseInt(course.time.split(':')[0]);
                    const existingStartMinute = parseInt(course.time.split(':')[1]);
                    const existingStartMinutes = existingStartHour * 60 + existingStartMinute;
                    const existingEndMinutes = existingStartMinutes + course.duration;
                    
                    return (newStartMinutes < existingEndMinutes && newEndMinutes > existingStartMinutes);
                }
                return false;
            });
            
            if (conflict) {
                showNotification(`è¯•è¯¾æ—¶é—´å†²çªï¼${conflict.studentName} åœ¨ ${getDayName(conflict.day)}${conflict.time} å·²æœ‰è¯¾ç¨‹å®‰æ’`, 'error');
                return;
            }
            
            // ä¿å­˜åˆ°Firebase
            firebase.database().ref('schedule').push(newCourse);
            
            showNotification(`è¯•è¯¾å­¦å‘˜ ${studentData.name} å·²è‡ªåŠ¨æ·»åŠ åˆ°è¯¾ç¨‹å®‰æ’ï¼`, 'success');
        }

        // æ›´æ–°è¯¾ç¨‹å®‰æ’æ¨¡å—çš„å­¦ç”Ÿé€‰é¡¹
        function updateScheduleStudentOptions() {
            // è·å–æ‰€æœ‰å­¦ç”Ÿ
            const formalStudents = Array.from(document.querySelectorAll('#formal-students .student-card')).map(card => ({
                name: card.getAttribute('data-name'),
                subject: card.getAttribute('data-subject'),
                grade: card.getAttribute('data-grade'),
                type: 'formal'
            }));
            
            const trialStudents = Array.from(document.querySelectorAll('#trial-students .student-card')).map(card => ({
                name: card.getAttribute('data-name'),
                subject: card.getAttribute('data-subject'),
                grade: card.getAttribute('data-grade'),
                type: 'trial'
            }));
            
            const allStudents = [...formalStudents, ...trialStudents];
            
            // æ›´æ–°è¯¾ç¨‹å®‰æ’æ¨¡æ€æ¡†ä¸­çš„å­¦ç”Ÿé€‰æ‹©ä¸‹æ‹‰æ¡†
            const scheduleStudentSelect = document.querySelector('select[name="studentName"]');
            if (scheduleStudentSelect) {
                // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
                const currentValue = scheduleStudentSelect.value;
                
                // æ¸…ç©ºç°æœ‰é€‰é¡¹
                scheduleStudentSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å­¦å‘˜</option>';
                
                // æ·»åŠ æ–°çš„å­¦ç”Ÿé€‰é¡¹
                allStudents.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.name;
                    option.textContent = `${student.name} (${student.grade} Â· ${student.subject} Â· ${student.type === 'trial' ? 'è¯•è¯¾' : 'æ­£å¼'})`;
                    scheduleStudentSelect.appendChild(option);
                });
                
                // æ¢å¤ä¹‹å‰é€‰ä¸­çš„å€¼ï¼ˆå¦‚æœè¿˜å­˜åœ¨ï¼‰
                if (currentValue && allStudents.some(s => s.name === currentValue)) {
                    scheduleStudentSelect.value = currentValue;
                }
            }
        }

        // åˆ‡æ¢è¯•è¯¾æ—¶é—´å­—æ®µæ˜¾ç¤º
        function toggleTrialTime(value) {
            const trialTimeField = document.getElementById('trial-time-field');
            const typeSelect = document.querySelector('select[name="type"]');
            const subjectSelect = document.querySelector('select[name="subject"]');
            
            // å¦‚æœé€‰æ‹©äº†è¯•è¯¾å­¦å‘˜ï¼Œæ˜¾ç¤ºè¯•è¯¾æ—¶é—´å­—æ®µ
            if (typeSelect.value === 'trial' && subjectSelect.value !== '') {
                trialTimeField.style.display = 'block';
                trialTimeField.querySelector('input').required = true;
            } else {
                trialTimeField.style.display = 'none';
                trialTimeField.querySelector('input').required = false;
            }
        }

        // åˆ›å»ºå­¦ç”Ÿå¡ç‰‡
        function createStudentCard(studentData) {
            const card = document.createElement('div');
            card.className = 'card student-card';
            card.setAttribute('data-subject', studentData.subject);
            card.setAttribute('data-name', studentData.name);
            card.setAttribute('data-grade', studentData.grade);
            
            const today = new Date().toISOString().split('T')[0];
            
            if (studentData.type === 'trial') {
                // æ ¼å¼åŒ–è¯•è¯¾æ—¶é—´
                const trialTime = studentData.trialTime ? new Date(studentData.trialTime).toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '';
                
                            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">${studentData.name}</h3>
                        <p class="text-sm text-gray-600">${studentData.grade} Â· ${studentData.subject}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                            è¯•å­¦ä¸­
                        </span>
                        <button class="text-green-600 hover:text-green-700 transition-colors" onclick="convertToFormal(this)" title="è½¬ä¸ºæ­£å¼æˆå‘˜">
                            <i data-lucide="check-circle" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
                <div class="space-y-2 text-sm text-gray-600">
                    <p>ğŸ“ ${studentData.phone}</p>
                    <p>ğŸ“ åŒ—äº¬å¸‚</p>
                    <p>ğŸ“… åŠ å…¥æ—¶é—´: ${today}</p>
                    ${trialTime ? `<p>â° è¯•è¯¾æ—¶é—´: ${trialTime}</p>` : ''}
                </div>
                    <div class="flex gap-2 mt-4">
                        <button class="btn-primary text-sm">ç¼–è¾‘</button>
                        <button class="btn-secondary text-sm">æŸ¥çœ‹è¯¦æƒ…</button>
                        <button class="btn-secondary text-sm text-red-600 hover:text-red-700" onclick="deleteStudent(this)">åˆ é™¤</button>
                    </div>
                `;
            } else {
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">${studentData.name}</h3>
                            <p class="text-sm text-gray-600">${studentData.grade} Â· ${studentData.subject}</p>
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            æ­£å¼å­¦å‘˜
                        </span>
                    </div>
                    <div class="space-y-2 text-sm text-gray-600">
                        <p>ğŸ“ ${studentData.phone}</p>
                        <p>ğŸ“ åŒ—äº¬å¸‚</p>
                        <p>ğŸ“… åŠ å…¥æ—¶é—´: ${today}</p>
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button class="btn-primary text-sm">ç¼–è¾‘</button>
                        <button class="btn-secondary text-sm">æŸ¥çœ‹è¯¦æƒ…</button>
                        <button class="btn-secondary text-sm text-red-600 hover:text-red-700" onclick="deleteStudent(this)">åˆ é™¤</button>
                    </div>
                `;
            }
            
            return card;
        }

        // è¯¾ç¨‹æ•°æ® - ä»FirebaseåŠ è½½
        let scheduleData = [];

        // å­¦å‘˜é¢œè‰²æ˜ å°„ - åŠ¨æ€ç”Ÿæˆ
        const studentColors = {};
        
        // åŠ¨æ€ç”Ÿæˆå­¦å‘˜é¢œè‰²
        function generateStudentColor(studentName) {
            if (!studentColors[studentName]) {
                const colors = [
                    { bg: 'bg-pink-200', text: 'text-pink-800', border: 'border-pink-300' },
                    { bg: 'bg-indigo-200', text: 'text-indigo-800', border: 'border-indigo-300' },
                    { bg: 'bg-teal-200', text: 'text-teal-800', border: 'border-teal-300' },
                    { bg: 'bg-purple-200', text: 'text-purple-800', border: 'border-purple-300' },
                    { bg: 'bg-orange-200', text: 'text-orange-800', border: 'border-orange-300' },
                    { bg: 'bg-green-200', text: 'text-green-800', border: 'border-green-300' },
                    { bg: 'bg-blue-200', text: 'text-blue-800', border: 'border-blue-300' },
                    { bg: 'bg-red-200', text: 'text-red-800', border: 'border-red-300' }
                ];
                const colorIndex = Object.keys(studentColors).length % colors.length;
                studentColors[studentName] = colors[colorIndex];
            }
            return studentColors[studentName];
        }

        // ç”Ÿæˆæ—¶é—´è¡¨
        function generateScheduleTable() {
            const tableBody = document.getElementById('schedule-table-body');
            if (!tableBody) return;

            tableBody.innerHTML = '';
            // ç”Ÿæˆæ—¶é—´è¡Œï¼ˆ8:00-24:00ï¼Œæ¯30åˆ†é’Ÿä¸€è¡Œï¼‰
            for (let hour = 8; hour <= 23; hour++) {
                for (let minute = 0; minute < 60; minute += 30) {
                    const row = document.createElement('tr');
                    const timeCell = document.createElement('td');
                    timeCell.className = 'border border-gray-200 px-2 py-1 text-xs text-gray-600 bg-gray-50 font-medium';
                    const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    timeCell.textContent = timeString;
                    row.appendChild(timeCell);

                    // ä¸ºæ¯ä¸€å¤©åˆ›å»ºå•å…ƒæ ¼
                    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                    days.forEach(day => {
                        const cell = document.createElement('td');
                        cell.className = 'border border-gray-200 px-1 py-1 text-xs relative';
                        cell.setAttribute('data-day', day);
                        cell.setAttribute('data-time', timeString);
                        // æŸ¥æ‰¾è¯¥æ—¶é—´æ®µçš„è¯¾ç¨‹ï¼ˆåªæ˜¾ç¤ºæœªå®Œæˆçš„ï¼‰
                        const courses = scheduleData.filter(course => {
                            if (course.status === 'completed') return false;
                            const courseTime = course.time;
                            const courseHour = parseInt(courseTime.split(':')[0]);
                            const courseMinute = parseInt(courseTime.split(':')[1]);
                            const courseStartMinutes = courseHour * 60 + courseMinute;
                            const courseEndMinutes = courseStartMinutes + course.duration;
                            const currentMinutes = hour * 60 + minute;
                            const nextMinutes = currentMinutes + 30;
                            const matches = course.day === day && 
                                           courseStartMinutes <= currentMinutes && 
                                           courseEndMinutes > currentMinutes;
                            return matches;
                        });
                        if (courses.length > 0) {
                            const course = courses[0];
                            const studentColor = generateStudentColor(course.studentName);
                            const courseTime = course.time;
                            const courseHour = parseInt(courseTime.split(':')[0]);
                            const courseMinute = parseInt(courseTime.split(':')[1]);
                            const courseStartMinutes = courseHour * 60 + courseMinute;
                            const currentMinutes = hour * 60 + minute;
                            // æ‰€æœ‰å ç”¨æ ¼éƒ½æ˜¾ç¤ºå§“åå’ŒâˆšæŒ‰é’®
                            cell.className += ` ${studentColor.bg} ${studentColor.text} ${studentColor.border}`;
                            cell.innerHTML = `<div class=\"font-medium text-xs\">${course.studentName}</div>
                                <button class=\"absolute top-1 right-1 text-green-600 hover:text-green-700 transition-colors\" onclick=\"event.stopPropagation();completeCourseConfirm('${course.id}')\" title=\"æ ‡è®°å®Œæˆ\"><i data-lucide=\"check\" class=\"w-3 h-3\"></i></button>`;
                            cell.onclick = (event) => {
                                if (event.target.closest('button')) {
                                    return;
                                }
                                showCourseStudentDetail(course);
                            };
                            cell.style.cursor = 'pointer';
                            setTimeout(() => {
                                lucide.createIcons();
                            }, 0);
                        }
                        row.appendChild(cell);
                    });
                    tableBody.appendChild(row);
                }
            }
        }

        // æ˜¾ç¤ºè¯¾ç¨‹è¯¦æƒ…
        function showCourseDetails(course) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 overflow-y-auto';
            modal.innerHTML = `
                <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                        <div class="absolute inset-0 bg-gray-500 opacity-75" onclick="closeModal()"></div>
                    </div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900">è¯¾ç¨‹è¯¦æƒ…</h3>
                                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div class="space-y-3">
                                <div>
                                    <span class="font-medium text-gray-700">å­¦å‘˜å§“åï¼š</span>
                                    <span class="text-gray-900">${course.studentName}</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700">ç§‘ç›®ï¼š</span>
                                    <span class="text-gray-900">${course.subject}</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700">æ—¶é—´ï¼š</span>
                                    <span class="text-gray-900">${getDayName(course.day)}${course.time}</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700">æ—¶é•¿ï¼š</span>
                                    <span class="text-gray-900">${course.duration}åˆ†é’Ÿ</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700">ç±»å‹ï¼š</span>
                                    <span class="text-gray-900">${course.type === 'trial' ? 'è¯•è¯¾å­¦å‘˜' : 'æ­£å¼å­¦å‘˜'}</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700">çŠ¶æ€ï¼š</span>
                                    <span class="text-gray-900">${getStatusName(course.status)}</span>
                                </div>
                            </div>
                            <div class="flex gap-3 mt-6">
                                <button onclick="editCourse('${course.id}')" class="btn-primary flex-1">ç¼–è¾‘</button>
                                <button onclick="deleteCourse('${course.id}')" class="btn-secondary flex-1 text-red-600">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            lucide.createIcons();
        }

        // è·å–æ˜ŸæœŸåç§°
        function getDayName(day) {
            try {
                const dayNames = {
                    'monday': 'å‘¨ä¸€',
                    'tuesday': 'å‘¨äºŒ',
                    'wednesday': 'å‘¨ä¸‰',
                    'thursday': 'å‘¨å››',
                    'friday': 'å‘¨äº”',
                    'saturday': 'å‘¨å…­',
                    'sunday': 'å‘¨æ—¥'
                };
                const dayName = dayNames[day] || day;
                return dayName;
            } catch (error) {
                console.error('Error in getDayName:', error);
                return day || 'æœªçŸ¥';
            }
        }

        // è·å–çŠ¶æ€åç§°
        function getStatusName(status) {
            const statusNames = {
                'scheduled': 'å·²å®‰æ’',
                'completed': 'å·²å®Œæˆ',
                'cancelled': 'å·²å–æ¶ˆ'
            };
            return statusNames[status] || status;
        }

        // æ˜¾ç¤ºæ·»åŠ è¯¾ç¨‹æ¨¡æ€æ¡†
        function showAddScheduleModal() {
            // è·å–å­¦å‘˜ç®¡ç†é¡µé¢ä¸­å®é™…å­˜åœ¨çš„å­¦å‘˜
            const formalStudents = Array.from(document.querySelectorAll('#formal-students .student-card')).map(card => ({
                name: card.getAttribute('data-name'),
                subject: card.getAttribute('data-subject'),
                grade: card.getAttribute('data-grade'),
                type: 'formal'
            }));
            
            const trialStudents = Array.from(document.querySelectorAll('#trial-students .student-card')).map(card => ({
                name: card.getAttribute('data-name'),
                subject: card.getAttribute('data-subject'),
                grade: card.getAttribute('data-grade'),
                type: 'trial'
            }));
            
            const allStudents = [...formalStudents, ...trialStudents];
            
            if (allStudents.length === 0) {
                showNotification('è¯·å…ˆåœ¨å­¦å‘˜ç®¡ç†ä¸­æ·»åŠ å­¦å‘˜ï¼', 'error');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 overflow-y-auto';
            modal.innerHTML = `
                <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                        <div class="absolute inset-0 bg-gray-500 opacity-75" onclick="closeModal()"></div>
                    </div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900">å®‰æ’è¯¾ç¨‹</h3>
                                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <form onsubmit="addNewCourse(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">é€‰æ‹©å­¦å‘˜ *</label>
                                        <select name="studentName" required class="input-field">
                                            <option value="">è¯·é€‰æ‹©å­¦å‘˜</option>
                                            ${allStudents.map(student => 
                                                `<option value="${student.name}">${student.name} (${student.grade} Â· ${student.subject} Â· ${student.type === 'trial' ? 'è¯•è¯¾' : 'æ­£å¼'})</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">æ˜ŸæœŸ *</label>
                                        <select name="day" required class="input-field">
                                            <option value="">è¯·é€‰æ‹©æ˜ŸæœŸ</option>
                                            <option value="monday">å‘¨ä¸€</option>
                                            <option value="tuesday">å‘¨äºŒ</option>
                                            <option value="wednesday">å‘¨ä¸‰</option>
                                            <option value="thursday">å‘¨å››</option>
                                            <option value="friday">å‘¨äº”</option>
                                            <option value="saturday">å‘¨å…­</option>
                                            <option value="sunday">å‘¨æ—¥</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 mb-1">æ—¶é—´ *</label>
                                        <input type="time" name="time" required class="input-field">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰ *</label>
                                        <input type="number" name="duration" min="30" max="180" step="30" value="60" required class="input-field">
                                    </div>
                                </div>
                                <div class="flex gap-3 mt-6">
                                    <button type="submit" class="btn-primary flex-1">å®‰æ’è¯¾ç¨‹</button>
                                    <button type="button" onclick="closeModal()" class="btn-secondary flex-1">å–æ¶ˆ</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            lucide.createIcons();
        }

        // æ·»åŠ æ–°è¯¾ç¨‹
        function addNewCourse(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const courseData = Object.fromEntries(formData);
            
            // ç¡®å®šå­¦å‘˜ç±»å‹å’Œç§‘ç›®
            const studentInfo = getStudentInfo(courseData.studentName);
            
            const newCourse = {
                id: Date.now().toString(),
                studentName: courseData.studentName,
                subject: studentInfo.subject,
                day: courseData.day,
                time: courseData.time,
                duration: parseInt(courseData.duration),
                type: studentInfo.type,
                status: 'scheduled'
            };
            
            // æ£€æŸ¥æ—¶é—´å†²çª
            const conflict = scheduleData.find(course => {
                if (course.day === courseData.day && course.status !== 'completed') {
                    const newStart = parseInt(courseData.time.split(':')[0]);
                    const newEnd = newStart + Math.ceil(parseInt(courseData.duration) / 60);
                    const existingStart = parseInt(course.time.split(':')[0]);
                    const existingEnd = existingStart + Math.ceil(course.duration / 60);
                    
                    return (newStart < existingEnd && newEnd > existingStart);
                }
                return false;
            });
            
            if (conflict) {
                showNotification(`æ—¶é—´å†²çªï¼${conflict.studentName} åœ¨ ${getDayName(conflict.day)}${conflict.time} å·²æœ‰è¯¾ç¨‹å®‰æ’`, 'error');
                return;
            }
            
            // ä¿å­˜åˆ°Firebase
            firebase.database().ref('schedule').push(newCourse);
            
            closeModal();
            showNotification(`è¯¾ç¨‹å®‰æ’æˆåŠŸï¼${courseData.studentName} - ${studentInfo.subject}`, 'success');
        }

        // è·å–å­¦å‘˜ä¿¡æ¯
        function getStudentInfo(studentName) {
            const studentMap = window.studentMap || {};
            return studentMap[studentName] || { subject: 'æœªçŸ¥', type: 'formal', grade: 'æœªçŸ¥' };
        }

        // ç¼–è¾‘è¯¾ç¨‹
        function editCourse(courseId) {
            // è¿™é‡Œå¯ä»¥æ·»åŠ ç¼–è¾‘è¯¾ç¨‹çš„é€»è¾‘
            showNotification('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        // å·²å®Œæˆè¯¾ç¨‹è®°å½• - ä»FirebaseåŠ è½½
        let completedCourses = [];
        
        // è·å–æ‰€æœ‰å·²å®Œæˆçš„è¯¾ç¨‹
        function getCurrentMonthCompletedCourses() {
            try {
                return completedCourses;
            } catch (error) {
                console.error('Error in getCurrentMonthCompletedCourses:', error);
                return [];
            }
        }

        // å®Œæˆè¯¾ç¨‹
        function completeCourse(courseId, button) {
            try {
                const courseIndex = scheduleData.findIndex(course => course.id === courseId);
                
                if (courseIndex !== -1) {
                    const course = scheduleData[courseIndex];
                    
                    // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
                    if (confirm(`æ˜¯å¦å®Œæˆè¯¾ç¨‹ï¼Ÿ\n\nå­¦å‘˜ï¼š${course.studentName}\nç§‘ç›®ï¼š${course.subject}\næ—¶é—´ï¼š${getDayName(course.day)}${course.time}\nç±»å‹ï¼š${course.type === 'trial' ? 'è¯•è¯¾' : 'æ­£è¯¾'}\næ—¶é•¿ï¼š${course.duration}åˆ†é’Ÿ`)) {
                        const completedCourse = {
                            ...course,
                            completedTime: new Date().toLocaleString('zh-CN'),
                            status: 'completed'
                        };
                        
                        // ä¿å­˜åˆ°Firebaseå·²å®Œæˆè¯¾ç¨‹
                        firebase.database().ref('completed').push(completedCourse);
                        
                        // ä»Firebaseè¯¾ç¨‹å®‰æ’ä¸­åˆ é™¤
                        firebase.database().ref('schedule/' + courseId).remove();
                        
                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        showNotification(`${course.studentName} çš„è¯¾ç¨‹å·²å®Œæˆï¼`, 'success');
                    }
                } else {
                    showNotification('è¯¾ç¨‹æœªæ‰¾åˆ°ï¼', 'error');
                }
            } catch (error) {
                console.error('Error in completeCourse:', error);
                showNotification('å®Œæˆè¯¾ç¨‹æ—¶å‡ºç°é”™è¯¯ï¼š' + error.message, 'error');
            }
        }

        // åˆ é™¤è¯¾ç¨‹
        function deleteCourse(courseId) {
            const courseIndex = scheduleData.findIndex(course => course.id === courseId);
            if (courseIndex !== -1) {
                const course = scheduleData[courseIndex];
                if (confirm(`ç¡®å®šè¦åˆ é™¤ ${course.studentName} çš„è¯¾ç¨‹å—ï¼Ÿ`)) {
                    // ä»Firebaseåˆ é™¤
                    firebase.database().ref('schedule/' + courseId).remove();
                    
                    closeModal();
                    showNotification(`è¯¾ç¨‹å·²åˆ é™¤ï¼`, 'success');
                }
            }
        }

        // æ›´æ–°å·²å®Œæˆè¯¾ç¨‹åˆ—è¡¨
        function updateCompletedCoursesList() {
            try {
                const completedList = document.getElementById('completed-courses-list');
                const completedCount = document.getElementById('completed-count');
                
                if (!completedList) {
                    return;
                }
                
                completedList.innerHTML = '';
                
                // æ˜¾ç¤ºæ‰€æœ‰å·²å®Œæˆçš„è¯¾ç¨‹
                const currentMonthCourses = getCurrentMonthCompletedCourses();
                completedCount.textContent = currentMonthCourses.length;
                
                let totalSalary = 0;
                
                currentMonthCourses.forEach(course => {
                    const coursePrice = parseFloat(getCoursePrice(course));
                    totalSalary += coursePrice;
                    
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-100 hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="py-3 px-4">${course.studentName}</td>
                        <td class="py-3 px-4">${course.subject}</td>
                        <td class="py-3 px-4">${getStudentGrade(course.studentName)}</td>
                        <td class="py-3 px-4">${getDayName(course.day)}${course.time}</td>
                        <td class="py-3 px-4">${course.completedTime}</td>
                        <td class="py-3 px-4">
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${
                                    course.type === 'trial' ? 'bg-yellow-100 text-yellow-800' : 
                                    course.type === 'converted' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'
                                }">
                                    ${course.type === 'trial' ? 'è¯•è¯¾' : 
                                      course.type === 'converted' ? 'æ­£å¼ï¼ˆè½¬æ­£ï¼‰' : 'æ­£å¼'}ï¼ˆ${course.duration}åˆ†é’Ÿï¼‰
                                    </span>
                                ${course.type === 'trial' ? `
                                    <button class="text-green-600 hover:text-green-700 transition-colors" onclick="convertTrialToFormal('${course.id}')" title="è½¬ä¸ºæ­£å¼">
                                        <i data-lucide="check-circle" class="w-4 h-4"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                        <td class="py-3 px-4">Â¥${getCoursePrice(course)}</td>
                    `;
                    completedList.appendChild(row);
                });
                
                // æ·»åŠ æ€»è–ªèµ„è¡Œ
                const totalRow = document.createElement('tr');
                totalRow.className = 'border-t-2 border-gray-300 bg-gray-50 font-semibold';
                totalRow.innerHTML = `
                    <td class="py-3 px-4" colspan="6">æ€»è–ªèµ„</td>
                    <td class="py-3 px-4">Â¥${totalSalary.toFixed(1)}</td>
                `;
                completedList.appendChild(totalRow);
                
                // é‡æ–°åˆå§‹åŒ–å›¾æ ‡
                setTimeout(() => {
                    lucide.createIcons();
                }, 0);
            } catch (error) {
                console.error('Error in updateCompletedCoursesList:', error);
                showNotification('æ›´æ–°å·²å®Œæˆè¯¾ç¨‹åˆ—è¡¨æ—¶å‡ºç°é”™è¯¯ï¼š' + error.message, 'error');
            }
        }

        // è·å–å­¦å‘˜å¹´çº§
        function getStudentGrade(studentName) {
            try {
                const studentCard = document.querySelector(`[data-name="${studentName}"]`);
                const grade = studentCard ? studentCard.getAttribute('data-grade') || 'æœªçŸ¥' : 'æœªçŸ¥';
                return grade;
            } catch (error) {
                console.error('Error in getStudentGrade:', error);
                return 'æœªçŸ¥';
            }
        }

        // è¯•è¯¾è½¬æ­£åŠŸèƒ½
        function convertTrialToFormal(courseId) {
            const courseIndex = completedCourses.findIndex(course => course.id === courseId);
            if (courseIndex !== -1) {
                const course = completedCourses[courseIndex];
                
                if (confirm(`æ˜¯å¦ç¡®è®¤è½¬æ­£ï¼Ÿ\nå­¦å‘˜ï¼š${course.studentName}\nç§‘ç›®ï¼š${course.subject}\nå¹´çº§ï¼š${getStudentGrade(course.studentName)}`)) {
                    // æ›´æ–°è¯¾ç¨‹ç±»å‹ä¸ºè½¬æ­£
                    completedCourses[courseIndex].type = 'converted';
                    
                    // æ›´æ–°å­¦å‘˜ç®¡ç†ä¸­çš„çŠ¶æ€
                    const studentCard = document.querySelector(`[data-name="${course.studentName}"]`);
                    if (studentCard) {
                        // æ‰¾åˆ°è¯•è¯¾å­¦å‘˜å¡ç‰‡å¹¶ç§»åŠ¨åˆ°æ­£å¼å­¦å‘˜åŒºåŸŸ
                        const trialStudentsContainer = document.getElementById('trial-students');
                        const formalStudentsContainer = document.getElementById('formal-students');
                        
                        if (trialStudentsContainer && formalStudentsContainer) {
                            // æ›´æ–°å¡ç‰‡çŠ¶æ€
                            const statusSpan = studentCard.querySelector('.bg-yellow-100');
                            if (statusSpan) {
                                statusSpan.className = 'px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
                                statusSpan.textContent = 'æ­£å¼å­¦å‘˜';
                            }
                            
                            // ç§»é™¤è½¬æ­£æŒ‰é’®
                            const convertButton = studentCard.querySelector('.text-green-600');
                            if (convertButton) {
                                convertButton.remove();
                            }
                            
                            // ç§»åŠ¨åˆ°æ­£å¼å­¦å‘˜åŒºåŸŸ
                            formalStudentsContainer.appendChild(studentCard);
                        }
                    }
                    
                    // æ›´æ–°å·²å®Œæˆè¯¾ç¨‹åˆ—è¡¨
                    updateCompletedCoursesList();
                    
                    // æ›´æ–°ä»ªè¡¨æ¿ç»Ÿè®¡
                    updateDashboardStats();
                    
                    showNotification(`${course.studentName} å·²æˆåŠŸè½¬ä¸ºæ­£å¼å­¦å‘˜ï¼`, 'success');
                }
            }
        }

        // è®¡ç®—è¯¾ç¨‹ä»·æ ¼
        function getCoursePrice(course) {
            try {
                const grade = getStudentGrade(course.studentName);
                const hours = course.duration / 60; // è½¬æ¢ä¸ºå°æ—¶
                
                if (course.type === 'trial') {
                    return '39.9';
                } else if (course.type === 'converted') {
                    return '99.9';
                } else if (course.type === 'formal') {
                    let hourlyRate = 50; // é»˜è®¤åˆä¸­ä»·æ ¼
                    switch (grade) {
                        case 'å°å­¦':
                            hourlyRate = 40;
                            break;
                        case 'åˆä¸­':
                            hourlyRate = 50;
                            break;
                        case 'é«˜ä¸­':
                            hourlyRate = 60;
                            break;
                    }
                    return (hourlyRate * hours).toFixed(1);
                }
                return '0';
            } catch (error) {
                console.error('Error in getCoursePrice:', error);
                return '0';
            }
        }

        // æ›´æ–°è¯•è¯¾å­¦å‘˜åˆ—è¡¨
        function updateTrialStudentsList() {
            const trialList = document.getElementById('trial-students-list');
            if (!trialList) return;
            
            trialList.innerHTML = '';
            
            // è·å–è¯•è¯¾å­¦å‘˜
            const trialStudents = Array.from(document.querySelectorAll('#trial-students .student-card')).map(card => {
                const phoneElement = card.querySelector('p');
                const phone = phoneElement ? phoneElement.textContent.replace('ğŸ“ ', '') : '';
                
                // è·å–è¯•è¯¾æ—¶é—´
                const timeElements = card.querySelectorAll('p');
                let trialTime = '';
                for (let element of timeElements) {
                    if (element.textContent.includes('è¯•è¯¾æ—¶é—´')) {
                        trialTime = element.textContent.replace('â° è¯•è¯¾æ—¶é—´: ', '');
                        break;
                    }
                }
                
                return {
                    name: card.getAttribute('data-name'),
                    subject: card.getAttribute('data-subject'),
                    grade: card.getAttribute('data-grade'),
                    phone: phone,
                    trialTime: trialTime
                };
            });
            
            trialStudents.forEach(student => {
                const card = document.createElement('div');
                card.className = 'card cursor-pointer hover:shadow-md transition-shadow';
                card.onclick = () => showCoachInputModal(student);
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">${student.name}</h3>
                            <p class="text-sm text-gray-600">${student.grade} Â· ${student.subject}</p>
                            <p class="text-sm text-gray-500">ğŸ“ ${student.phone}</p>
                            ${student.trialTime ? `<p class="text-sm text-gray-500">â° ${student.trialTime}</p>` : ''}
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                            è¯•è¯¾å­¦å‘˜
                        </span>
                    </div>
                    <div class="text-sm text-gray-600">
                        ç‚¹å‡»ç”Ÿæˆè¯•å­¦æµç¨‹
                    </div>
                `;
                trialList.appendChild(card);
            });
        }

        // æ˜¾ç¤ºæ•™ç»ƒè¾“å…¥æ¨¡æ€æ¡†
        function showCoachInputModal(student) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 overflow-y-auto';
            modal.innerHTML = `
                <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                        <div class="absolute inset-0 bg-gray-500 opacity-75" onclick="closeModal()"></div>
                    </div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900">ç”Ÿæˆè¯•å­¦æµç¨‹</h3>
                                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <form onsubmit="generateTrialProcess(event, '${student.name}')">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">æ•™ç»ƒå§“å *</label>
                                        <input type="text" name="coachName" required class="input-field" placeholder="è¯·è¾“å…¥æ•™ç»ƒå§“å">
                                    </div>
                                </div>
                                <div class="flex gap-3 mt-6">
                                    <button type="submit" class="btn-primary flex-1">ç”Ÿæˆæµç¨‹</button>
                                    <button type="button" onclick="closeModal()" class="btn-secondary flex-1">å–æ¶ˆ</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            lucide.createIcons();
        }

        // ç”Ÿæˆè¯•å­¦æµç¨‹
        function generateTrialProcess(event, studentName) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const coachName = formData.get('coachName');
            
            // è·å–å­¦å‘˜ä¿¡æ¯
            const studentCard = document.querySelector(`[data-name="${studentName}"]`);
            const subject = studentCard ? studentCard.getAttribute('data-subject') : 'æ•°å­¦';
            const grade = studentCard ? studentCard.getAttribute('data-grade') : 'åˆä¸­';
            
            // è·å–å­¦å‘˜ä¸Šè¯¾æ—¶é—´ä¿¡æ¯
            let trialTime = '';
            if (studentCard) {
                const timeElements = studentCard.querySelectorAll('p');
                for (let element of timeElements) {
                    if (element.textContent.includes('è¯•è¯¾æ—¶é—´')) {
                        trialTime = element.textContent.replace('â° è¯•è¯¾æ—¶é—´: ', '');
                        break;
                    }
                }
            }
            
            // è·å–å­¦å‘˜ç”µè¯ä¿¡æ¯
            let phone = '';
            if (studentCard) {
                const phoneElements = studentCard.querySelectorAll('p');
                for (let element of phoneElements) {
                    if (element.textContent.includes('ğŸ“')) {
                        phone = element.textContent.replace('ğŸ“ ', '');
                        break;
                    }
                }
            }
            
            const processText = `ğŸŒˆ${studentName}åŒå­¦å®¶é•¿æ‚¨å¥½ï¼

â¤ï¸æˆ‘æ˜¯å­©å­çš„ä½“éªŒè¯¾æ•™ç»ƒ${coachName}ï¼Œè´Ÿè´£å­©å­çš„ä¸‡æ ¡äº’è”AI${subject}å­¦ä¹ ã€å¤ä¹ è¿‡ç¨‹çš„å¼•å¯¼ã€é™ªä¼´ã€ç›‘ç£ä¸æŒ‡å¯¼ï¼Œå¹¶ä¼šåŠæ—¶åœ¨ç¾¤å†…å‘é€å­¦å‘˜å­¦ä¹ å’Œå¤ä¹ æŠ¥å‘Šï¼Œè¯·æ‚¨å…³æ³¨ï¼

ğŸ“š å­¦å‘˜ä¿¡æ¯ï¼š
å§“åï¼š${studentName}
å¹´çº§ï¼š${grade}
ç§‘ç›®ï¼š${subject}
ç”µè¯ï¼š${phone}
${trialTime ? `è¯•è¯¾æ—¶é—´ï¼š${trialTime}` : ''}

â¤ï¸æˆ‘ä¼šæå‰å°†è¯¾ç¨‹é“¾æ¥å‘é€è‡³ç¾¤é‡Œ

è¯·æå‰ä¸‹è½½å¥½â€”â€”
è…¾è®¯ä¼šè®®ï¼Œç”µè„‘ã€ç¬”è®°æœ¬ï¼Œå¹³æ¿ã€æ‰‹æœºéƒ½å¯ä»¥ä½¿ç”¨ï¼ˆå°å¼ç”µè„‘å¿…é¡»é…å¤‡è€³æœºï¼‰

è¯·æå‰å®‰æ’å¥½æ—¶é—´æˆ‘ä»¬å‡†æ—¶ä¸Šè¯¾å“¦ï¼âœŠâœŠ

ğŸŒ»å¼˜æ‰¬ğŸŒ»äº¤ä»˜ä¸­å¿ƒç¥æ‚¨ä½“éªŒæ„‰å¿«

â°ä¸Šè¯¾æé†’â°

æ˜æ—¥çš„é«˜åº¦
å–æ±ºäºä»Šæ—¥çš„é€‰æ‹©
å­¦ä¹ ä»å…´è¶£å¼€å§‹
æ¢¦æƒ³ä»è¿™é‡Œå¯èˆª

${trialTime ? `ï¼ˆ${trialTime}ï¼‰` : 'ï¼ˆä¸Šè¯¾æ—¶é—´ï¼‰'}æˆ‘ä»¬ä¸€èµ·è¿›è¡Œè¯•è¯¾å­¦ä¹ `;
            
            // æ˜¾ç¤ºç”Ÿæˆçš„æµç¨‹æ–‡æœ¬
            showGeneratedProcess(processText, studentName);
            
            closeModal();
        }

        // æ˜¾ç¤ºç”Ÿæˆçš„æµç¨‹æ–‡æœ¬
        function showGeneratedProcess(text, studentName) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 overflow-y-auto';
            modal.innerHTML = `
                <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                        <div class="absolute inset-0 bg-gray-500 opacity-75" onclick="closeModal()"></div>
                    </div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900">${studentName} - è¯•å­¦æµç¨‹</h3>
                                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <pre class="text-sm text-gray-800 whitespace-pre-wrap font-sans">${text}</pre>
                            </div>
                            <div class="flex gap-3 mt-6">
                                <button onclick="copyToClipboard('${text.replace(/'/g, "\\'")}')" class="btn-primary flex-1">å¤åˆ¶æ–‡æœ¬</button>
                                <button onclick="closeModal()" class="btn-secondary flex-1">å…³é—­</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            lucide.createIcons();
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('æ–‡æœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
            }).catch(() => {
                showNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            });
        }

        // åé¦ˆæ•°æ®å­˜å‚¨ - ä»FirebaseåŠ è½½
        let feedbackData = [];

        // æ˜¾ç¤ºæ·»åŠ åé¦ˆæ¨¡æ€æ¡†
        function showAddFeedbackModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 overflow-y-auto';
            modal.innerHTML = `
                <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                        <div class="absolute inset-0 bg-gray-500 opacity-75" onclick="closeModal()"></div>
                    </div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900">æ·»åŠ ä¼´å­¦åé¦ˆ</h3>
                                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <form id="ai-feedback-form" onsubmit="event.preventDefault();">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">å­¦å‘˜å§“å *</label>
                                        <input type="text" name="studentName" required class="input-field" placeholder="è¯·è¾“å…¥å­¦å‘˜å§“å">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">ä»Šå¤©å­¦ä¹ çš„å†…å®¹ *</label>
                                        <textarea name="learningContent" rows="3" required class="input-field" placeholder="è¯·è¾“å…¥ä»Šå¤©å­¦ä¹ çš„å…·ä½“å†…å®¹"></textarea>
                                    </div>
                                </div>
                                <div class="flex gap-3 mt-6">
                                    <button type="button" onclick="generateAIFeedbackFromSimpleForm()" class="btn-primary flex-1">AIç”Ÿæˆåé¦ˆ</button>
                                    <button type="button" onclick="closeModal()" class="btn-secondary flex-1">å–æ¶ˆ</button>
                                </div>
                            </form>
                            <div id="ai-feedback-result" class="mt-6 hidden">
                                <div class="bg-gray-50 p-4 rounded-lg border mb-4">
                                    <h4 class="font-medium text-gray-900 mb-2">AIåé¦ˆå†…å®¹</h4>
                                    <div id="ai-feedback-content" class="text-sm text-gray-800 whitespace-pre-line"></div>
                                </div>
                                <div class="flex gap-3">
                                    <button type="button" onclick="saveAIFeedback()" class="btn-primary flex-1">ä¿å­˜åé¦ˆ</button>
                                    <button type="button" onclick="closeModal()" class="btn-secondary flex-1">å…³é—­</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            lucide.createIcons();
        }

        // ç®€åŒ–AIåé¦ˆç”Ÿæˆ
        async function generateAIFeedbackFromSimpleForm() {
            const form = document.getElementById('ai-feedback-form');
            const studentName = form.studentName.value.trim();
            const learningContent = form.learningContent.value.trim();
            if (!studentName || !learningContent) {
                showNotification('è¯·å¡«å†™å­¦å‘˜å§“åå’Œå­¦ä¹ å†…å®¹', 'error');
                return;
            }
            if (!aiAnalyzer) aiAnalyzer = new AIFeedbackAnalyzer();
            showNotification('AIæ­£åœ¨ç”Ÿæˆåé¦ˆ...', 'info');
            // æ„é€ æœ€ç®€studentData
            const studentData = { name: studentName, subject: '', grade: '', type: 'formal', learningContent };
            const feedbackHistory = [];
            const result = await aiAnalyzer.generateFeedbackWithContent(studentData, feedbackHistory);
            if (result.success) {
                // å±•ç¤ºAIåé¦ˆå†…å®¹
                const resultDiv = document.getElementById('ai-feedback-result');
                const contentDiv = document.getElementById('ai-feedback-content');
                contentDiv.innerHTML =
                    `<b>å­¦ä¹ æƒ…å†µï¼š</b>\n${result.content}\n\n<b>å­¦ä¹ è¿›åº¦ï¼š</b>\n${result.progress}\n\n<b>ä¸‹ä¸€æ­¥è®¡åˆ’ï¼š</b>\n${result.nextSteps}`;
                resultDiv.classList.remove('hidden');
            } else {
                showNotification('AIåé¦ˆç”Ÿæˆå¤±è´¥', 'error');
            }
        }

        // ä¿å­˜AIåé¦ˆ
        function saveAIFeedback() {
            const form = document.getElementById('ai-feedback-form');
            const studentName = form.studentName.value.trim();
            const learningContent = form.learningContent.value.trim();
            const contentDiv = document.getElementById('ai-feedback-content');
            // è§£æAIåé¦ˆå†…å®¹
            const contentHtml = contentDiv.innerHTML;
            const [content, progress, nextSteps] = contentHtml.split(/<b>.*?ï¼š<\/b>\\n/).slice(1);
            const newFeedback = {
                id: 'feedback-' + Date.now(),
                studentName,
                subject: '',
                date: new Date().toISOString().split('T')[0],
                learningContent,
                content: content?.trim() || '',
                progress: progress?.trim() || '',
                nextSteps: nextSteps?.trim() || '',
                aiSuggestion: ''
            };
            
            // ä¿å­˜åˆ°Firebase
            firebase.database().ref('feedback').push(newFeedback);
            
            closeModal();
            showNotification('åé¦ˆä¿å­˜æˆåŠŸï¼', 'success');
        }

        // åˆå§‹åŒ–AIåˆ†æå™¨
        let aiAnalyzer = null;

        // ç”ŸæˆAIåé¦ˆ
        async function generateAIFeedback(studentName, subject, learningContent) {
            // åˆå§‹åŒ–AIåˆ†æå™¨
            if (!aiAnalyzer) {
                aiAnalyzer = new AIFeedbackAnalyzer();
            }

            showNotification('AIæ­£åœ¨ç”Ÿæˆåé¦ˆ...', 'info');
            
            try {
                // è·å–å­¦ç”Ÿä¿¡æ¯
                const studentCard = document.querySelector(`[data-name="${studentName}"]`);
                const grade = studentCard ? studentCard.getAttribute('data-grade') : 'åˆä¸­';
                const type = studentCard ? (studentCard.closest('#trial-students') ? 'trial' : 'formal') : 'formal';
                
                const studentData = {
                    name: studentName,
                    subject: subject,
                    grade: grade,
                    type: type,
                    learningContent: learningContent
                };

                // è·å–å†å²åé¦ˆè®°å½•
                const feedbackHistory = window.feedbackData.filter(f => f.studentName === studentName);
                
                // è°ƒç”¨AIåˆ†æ
                const result = await aiAnalyzer.generateFeedbackWithContent(studentData, feedbackHistory);
                
                if (result.success) {
                    // è‡ªåŠ¨å¡«å……è¡¨å•
                    const contentTextarea = document.querySelector('textarea[name="content"]');
                    const progressTextarea = document.querySelector('textarea[name="progress"]');
                    const nextStepsTextarea = document.querySelector('textarea[name="nextSteps"]');
                    
                    if (contentTextarea) contentTextarea.value = result.content || '';
                    if (progressTextarea) progressTextarea.value = result.progress || '';
                    if (nextStepsTextarea) nextStepsTextarea.value = result.nextSteps || '';
                    
                    showNotification('AIåé¦ˆç”Ÿæˆå®Œæˆï¼', 'success');
                } else {
                    showNotification('AIåé¦ˆç”Ÿæˆå¤±è´¥ï¼š' + result.error, 'error');
                }
            } catch (error) {
                console.error('AIåé¦ˆç”Ÿæˆé”™è¯¯:', error);
                showNotification('AIåé¦ˆç”Ÿæˆè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯', 'error');
            }
        }

        // ä»è¡¨å•ç”ŸæˆAIåé¦ˆ
        function generateAIFeedbackFromForm() {
            const studentName = document.querySelector('select[name="studentName"]').value;
            const subject = document.querySelector('input[name="subject"]').value;
            const learningContent = document.querySelector('textarea[name="learningContent"]').value;
            
            if (!studentName) {
                showNotification('è¯·å…ˆé€‰æ‹©å­¦å‘˜ï¼', 'error');
                return;
            }
            
            if (!learningContent.trim()) {
                showNotification('è¯·å…ˆè¾“å…¥ä»Šå¤©å­¦ä¹ çš„å†…å®¹ï¼', 'error');
                return;
            }
            
            generateAIFeedback(studentName, subject, learningContent);
        }

        // ç¼–è¾‘åé¦ˆ
        function editFeedback(feedbackId) {
            showNotification('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        // æŸ¥çœ‹åé¦ˆè¯¦æƒ…
        function viewFeedbackDetail(feedbackId) {
            showNotification('è¯¦æƒ…æŸ¥çœ‹åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        // æ˜¾ç¤ºAIé…ç½®æ¨¡æ€æ¡†
        function showAIConfigModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 overflow-y-auto';
            modal.innerHTML = `
                <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                        <div class="absolute inset-0 bg-gray-500 opacity-75" onclick="closeModal()"></div>
                    </div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg leading-6 font-medium text-gray-900">AIé…ç½®</h3>
                                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <form onsubmit="saveAIConfig(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">AI APIå¯†é’¥</label>
                                        <input type="password" name="apiKey" class="input-field" placeholder="è¯·è¾“å…¥AI APIå¯†é’¥ï¼ˆå¯é€‰ï¼‰">
                                        <p class="text-xs text-gray-500 mt-1">é…ç½®APIå¯†é’¥å¯ä½¿ç”¨çœŸå®AIæœåŠ¡ï¼Œå¦åˆ™ä½¿ç”¨æ¨¡æ‹ŸAI</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">AIæ¨¡å‹</label>
                                        <select name="model" class="input-field">
                                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                            <option value="gpt-4">GPT-4</option>
                                            <option value="claude-3">Claude-3</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">åˆ†ææ·±åº¦</label>
                                        <select name="depth" class="input-field">
                                            <option value="basic">åŸºç¡€åˆ†æ</option>
                                            <option value="detailed">è¯¦ç»†åˆ†æ</option>
                                            <option value="comprehensive">ç»¼åˆåˆ†æ</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="flex gap-3 mt-6">
                                    <button type="submit" class="btn-primary flex-1">ä¿å­˜é…ç½®</button>
                                    <button type="button" onclick="testAIConnection()" class="btn-secondary flex-1">æµ‹è¯•è¿æ¥</button>
                                    <button type="button" onclick="closeModal()" class="btn-secondary flex-1">å–æ¶ˆ</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            lucide.createIcons();
        }

        // ä¿å­˜AIé…ç½®
        function saveAIConfig(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const config = Object.fromEntries(formData);
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('aiConfig', JSON.stringify(config));
            
            // æ›´æ–°AIåˆ†æå™¨é…ç½®
            if (aiAnalyzer) {
                aiAnalyzer.setApiKey(config.apiKey);
            }
            
            closeModal();
            showNotification('AIé…ç½®å·²ä¿å­˜ï¼', 'success');
        }

        // æµ‹è¯•AIè¿æ¥
        async function testAIConnection() {
            const apiKey = document.querySelector('input[name="apiKey"]').value;
            
            if (!apiKey) {
                showNotification('è¯·å…ˆè¾“å…¥APIå¯†é’¥ï¼', 'error');
                return;
            }
            
            showNotification('æ­£åœ¨æµ‹è¯•AIè¿æ¥...', 'info');
            
            try {
                // è¿™é‡Œå¯ä»¥æ·»åŠ çœŸå®çš„APIè¿æ¥æµ‹è¯•
                setTimeout(() => {
                    showNotification('AIè¿æ¥æµ‹è¯•æˆåŠŸï¼', 'success');
                }, 2000);
            } catch (error) {
                showNotification('AIè¿æ¥æµ‹è¯•å¤±è´¥ï¼š' + error.message, 'error');
            }
        }

        // æ¸²æŸ“åé¦ˆåˆ—è¡¨
        function renderFeedbackList() {
            try {
                const feedbackList = document.getElementById('feedback-list');
                if (!feedbackList) return;
                
                feedbackList.innerHTML = '';
                
                if (feedbackData.length === 0) {
                    feedbackList.innerHTML = `
                        <div class="text-center py-12">
                            <i data-lucide="message-square" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">æš‚æ— åé¦ˆè®°å½•</h3>
                            <p class="text-gray-500 mb-4">å¼€å§‹æ·»åŠ ä¼´å­¦åé¦ˆåï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºåé¦ˆåˆ—è¡¨</p>
                            <button onclick="showAddFeedbackModal()" class="btn-primary">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                æ·»åŠ ç¬¬ä¸€ä¸ªåé¦ˆ
                            </button>
                        </div>
                    `;
                    return;
                }
                
                // åˆ›å»ºè¡¨æ ¼ç»“æ„
                feedbackList.innerHTML = `
                    <div class="card">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b border-gray-200">
                                        <th class="text-left py-3 px-4 font-medium text-gray-700">å­¦å‘˜å§“å</th>
                                        <th class="text-left py-3 px-4 font-medium text-gray-700">ç§‘ç›®</th>
                                        <th class="text-left py-3 px-4 font-medium text-gray-700">æ—¥æœŸ</th>
                                        <th class="text-left py-3 px-4 font-medium text-gray-700">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${feedbackData.map(feedback => `
                                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                                            <td class="py-3 px-4">${feedback.studentName}</td>
                                            <td class="py-3 px-4">${feedback.subject || '-'}</td>
                                            <td class="py-3 px-4">${feedback.date}</td>
                                            <td class="py-3 px-4">
                                                <div class="flex items-center gap-2">
                                                    <button onclick="viewFeedbackDetail('${feedback.id}')" class="text-blue-600 hover:text-blue-700 transition-colors" title="æŸ¥çœ‹è¯¦æƒ…">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="editFeedback('${feedback.id}')" class="text-green-600 hover:text-green-700 transition-colors" title="ç¼–è¾‘">
                                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // é‡æ–°åˆå§‹åŒ–å›¾æ ‡
                setTimeout(() => {
                    lucide.createIcons();
                }, 0);
            } catch (error) {
                console.error('Error in renderFeedbackList:', error);
            }
        }



        // é¡µé¢åŠ è½½æ—¶ç”Ÿæˆæ—¶é—´è¡¨å’Œå·²å®Œæˆè¯¾ç¨‹åˆ—è¡¨
        document.addEventListener('DOMContentLoaded', function() {
            // ç¡®ä¿é»˜è®¤æ˜¾ç¤ºä»ªè¡¨æ¿
            showTab('dashboard');
            
            generateScheduleTable();
            updateCompletedCoursesList();
            updateTrialStudentsList();
            
            // åˆå§‹åŒ–åé¦ˆæ•°æ®
            renderFeedbackList();
            
            // åˆå§‹åŒ–ä»ªè¡¨æ¿ç»Ÿè®¡
            updateDashboardStats();
            
            // åˆå§‹åŒ–è¯¾ç¨‹å®‰æ’æ¨¡å—çš„å­¦ç”Ÿé€‰é¡¹
            updateScheduleStudentOptions();
        });

        // æ·»åŠ æ ·å¼
        const style = document.createElement('style');
        style.textContent = `
            .tab-btn {
                @apply flex items-center gap-2 py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300;
            }
            .tab-btn.active {
                @apply border-blue-500 text-blue-600;
            }
            /* .tab-content {
                display: none;
            }
            .tab-content.active {
                display: block;
            } */
            /* ç¡®ä¿å†…å®¹åŒºåŸŸæ­£ç¡®æ˜¾ç¤º */
            #dashboard-content {
                display: block;
            }
        `;
        document.head.appendChild(style);

        console.log('scheduleData:', scheduleData);
        console.log('completedCourses:', completedCourses);

        // æµ‹è¯•å†™å…¥ä¸€æ¡æ•°æ®
        firebase.database().ref('test').set({
          hello: "world"
        });

        // æµ‹è¯•è¯»å–æ•°æ®
        firebase.database().ref('test').on('value', (snapshot) => {
          const data = snapshot.val();
          console.log("Firebase è¯»å–åˆ°çš„æ•°æ®ï¼š", data);
        });

        // æ·»åŠ å­¦ç”Ÿåˆ° Firebase
        function addStudentToFirebase(student) {
          firebase.database().ref('students').push(student);
        }

        // åˆ é™¤å­¦ç”Ÿ
        function deleteStudentFromFirebase(studentId) {
          firebase.database().ref('students/' + studentId).remove();
        }

        // æ¸²æŸ“å­¦ç”Ÿåˆ—è¡¨
        function renderStudentList(students) {
          const formalContainer = document.getElementById('formal-students');
          const trialContainer = document.getElementById('trial-students');
          formalContainer.innerHTML = '';
          trialContainer.innerHTML = '';
          students.forEach(student => {
            const card = createStudentCard(student);
            // ä¿®æ”¹åˆ é™¤æŒ‰é’®äº‹ä»¶
            const delBtn = card.querySelector('button[onclick^="deleteStudent"]');
            if (delBtn) {
              delBtn.setAttribute('onclick', `deleteStudentFromFirebase('${student.id}')`);
            }
            if (student.type === 'trial') {
              trialContainer.appendChild(card);
            } else {
              formalContainer.appendChild(card);
            }
          });
        }

        // ç›‘å¬å¹¶æ¸²æŸ“å­¦ç”Ÿåˆ—è¡¨
        firebase.database().ref('students').on('value', (snapshot) => {
          const studentsObj = snapshot.val() || {};
          const students = Object.entries(studentsObj).map(([id, data]) => ({ id, ...data }));
          renderStudentList(students);

          // è‡ªåŠ¨åŒæ­¥window.studentMap
          const studentMap = {};
          students.forEach(s => {
            studentMap[s.name] = { ...s };
          });
          window.studentMap = studentMap;

          // è‡ªåŠ¨ä¸ºæ‰€æœ‰è¯•è¯¾å­¦å‘˜åŒæ­¥è¯¾ç¨‹å®‰æ’
          firebase.database().ref('schedule').once('value').then(scheduleSnap => {
            const scheduleObj = scheduleSnap.val() || {};
            const scheduledTrialNames = Object.values(scheduleObj)
              .filter(c => c.type === 'trial')
              .map(c => c.studentName + (c.trialTime || ''));
            students.forEach(student => {
              if (student.type === 'trial' && student.trialTime) {
                const key = student.name + student.trialTime;
                if (!scheduledTrialNames.includes(key)) {
                  // è‡ªåŠ¨æ·»åŠ è¯•è¯¾è¯¾ç¨‹
                  const trialDate = new Date(student.trialTime);
                  const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                  const day = dayNames[trialDate.getDay()];
                  const time = trialDate.getHours().toString().padStart(2, '0') + ':' + trialDate.getMinutes().toString().padStart(2, '0');
                  const newCourse = {
                    studentName: student.name,
                    subject: student.subject,
                    day: day,
                    time: time,
                    duration: 60,
                    type: 'trial',
                    status: 'scheduled',
                    trialTime: student.trialTime,
                    phone: student.phone || ''
                  };
                  firebase.database().ref('schedule').push(newCourse);
                }
              }
            });
          });
        });

        // ç›‘å¬è¯¾ç¨‹å®‰æ’æ•°æ®
        firebase.database().ref('schedule').on('value', (snapshot) => {
          const scheduleObj = snapshot.val() || {};
          scheduleData = Object.entries(scheduleObj).map(([id, data]) => ({ id, ...data }));
          generateScheduleTable();
          updateDashboardStats();
        });

        // ç›‘å¬å·²å®Œæˆè¯¾ç¨‹æ•°æ®
        firebase.database().ref('completed').on('value', (snapshot) => {
          const completedObj = snapshot.val() || {};
          completedCourses = Object.entries(completedObj).map(([id, data]) => ({ id, ...data }));
          updateCompletedCoursesList();
          updateDashboardStats();
        });

        // ç›‘å¬åé¦ˆæ•°æ®
        firebase.database().ref('feedback').on('value', (snapshot) => {
          const feedbackObj = snapshot.val() || {};
          feedbackData = Object.entries(feedbackObj).map(([id, data]) => ({ id, ...data }));
          renderFeedbackList();
          updateDashboardStats();
        });

        // æ›¿æ¢åŸæœ‰ addNewStudent é€»è¾‘
        function addNewStudent(event) {
          event.preventDefault();
          const formData = new FormData(event.target);
          const studentData = Object.fromEntries(formData);
          addStudentToFirebase(studentData);
          closeModal();
          showNotification(`å­¦ç”Ÿ ${studentData.name} æ·»åŠ æˆåŠŸï¼`, 'success');
        }

        document.getElementById('auth-form').onsubmit = async function(e) {
          e.preventDefault();
          console.log('è¡¨å•æäº¤äº‹ä»¶è§¦å‘');
          authError.style.display = 'none';
          const phone = document.getElementById('auth-phone').value.trim();
          const password = document.getElementById('auth-password').value;
          console.log('è¾“å…¥æ‰‹æœºå·:', phone, 'è¾“å…¥å¯†ç :', password);
          if (!/^\d{11}$/.test(phone)) {
            authError.textContent = 'è¯·è¾“å…¥11ä½æ‰‹æœºå·';
            authError.style.display = 'block';
            console.log('æ‰‹æœºå·æ ¼å¼é”™è¯¯');
            return;
          }
          try {
            if (isLogin) {
              // ç™»å½•ï¼šæŸ¥æ‰¾æ‰‹æœºå·ï¼Œæ ¡éªŒå¯†ç 
              const snap = await firebase.database().ref('users/' + phone).once('value');
              const user = snap.val();
              console.log('æŸ¥åˆ°çš„ç”¨æˆ·ï¼š', user);
              if (!user) throw new Error('ç”¨æˆ·ä¸å­˜åœ¨');
              if (user.password !== password) throw new Error('å¯†ç é”™è¯¯');
              // ç™»å½•æˆåŠŸï¼Œè®°å½•çŠ¶æ€
              localStorage.setItem('loginPhone', phone);
              console.log('ç™»å½•æˆåŠŸï¼Œè¿›å…¥ä¸»é¡µé¢');
              showMainContent(phone);
            } else {
              // æ³¨å†Œï¼šæ‰‹æœºå·å”¯ä¸€
              const snap = await firebase.database().ref('users/' + phone).once('value');
              if (snap.exists()) throw new Error('æ‰‹æœºå·å·²æ³¨å†Œ');
              await firebase.database().ref('users/' + phone).set({
                phone,
                password,
                createdAt: new Date().toISOString()
              });
              localStorage.setItem('loginPhone', phone);
              console.log('æ³¨å†ŒæˆåŠŸï¼Œè¿›å…¥ä¸»é¡µé¢');
              showMainContent(phone);
            }
          } catch (err) {
            console.error('ç™»å½•/æ³¨å†Œå‡ºé”™ï¼š', err);
            authError.textContent = err.message;
            authError.style.display = 'block';
          }
        };

        let isLogin = true;
        const authTitle = document.getElementById('auth-title');
        const authSubmit = document.getElementById('auth-submit');
        const authToggleText = document.getElementById('auth-toggle-text');
        const authToggleLink = document.getElementById('auth-toggle-link');
        const authError = document.getElementById('auth-error');

        // åœ¨æœ«å°¾æ·»åŠ è¯¦æƒ…å¼¹çª—å‡½æ•°
        function showCourseStudentDetail(course) {
            // ä¼˜å…ˆç”¨course.phoneï¼Œæ²¡æœ‰åˆ™ä»window.studentMapæŸ¥æ‰¾
            let phone = course.phone;
            if (!phone && window.studentMap && window.studentMap[course.studentName]) {
                phone = window.studentMap[course.studentName].phone || '';
            }
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 overflow-y-auto';
            modal.innerHTML = `
                <div class=\"flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0\">
                    <div class=\"fixed inset-0 transition-opacity\" aria-hidden=\"true\">
                        <div class=\"absolute inset-0 bg-gray-500 opacity-75\" onclick=\"closeModal()\"></div>
                    </div>
                    <span class=\"hidden sm:inline-block sm:align-middle sm:h-screen\" aria-hidden=\"true\">&#8203;</span>
                    <div class=\"inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full\">
                        <div class=\"bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4\">
                            <div class=\"flex items-center justify-between mb-4\">
                                <h3 class=\"text-lg leading-6 font-medium text-gray-900\">å­¦å‘˜è¯¦æƒ…</h3>
                                <button onclick=\"closeModal()\" class=\"text-gray-400 hover:text-gray-600 transition-colors\">
                                    <i data-lucide=\"x\" class=\"w-5 h-5\"></i>
                                </button>
                            </div>
                            <div class=\"space-y-3\">
                                <div><span class=\"font-medium text-gray-700\">å§“åï¼š</span><span class=\"text-gray-900\">${course.studentName}</span></div>
                                <div><span class=\"font-medium text-gray-700\">ç§‘ç›®ï¼š</span><span class=\"text-gray-900\">${course.subject}</span></div>
                                <div><span class=\"font-medium text-gray-700\">ä¸Šè¯¾æ—¶é—´ï¼š</span><span class=\"text-gray-900\">${getDayName(course.day)} ${course.time}</span></div>
                                <div><span class=\"font-medium text-gray-700\">ç”µè¯ï¼š</span><span class=\"text-gray-900\">${phone || ''}</span></div>
                            </div>
                            <div class=\"flex gap-3 mt-6\">
                                <button onclick=\"closeModal()\" class=\"btn-secondary flex-1\">å…³é—­</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            lucide.createIcons();
        }

        // åœ¨æœ«å°¾æ·»åŠ æ ‡è®°å®Œæˆç¡®è®¤å’Œå†™å…¥å·²å®Œæˆè¯¾ç¨‹çš„å‡½æ•°
        function completeCourseConfirm(courseId) {
            const course = scheduleData.find(c => c.id === courseId);
            if (!course) return;
            if (confirm(`æ˜¯å¦å®Œæˆè¯¾ç¨‹ï¼Ÿ\n\nå­¦å‘˜ï¼š${course.studentName}\nç§‘ç›®ï¼š${course.subject}\næ—¶é—´ï¼š${getDayName(course.day)} ${course.time}`)) {
                // è®¡ç®—è–ªèµ„
                let salary = 0;
                let grade = '';
                if (window.studentMap && window.studentMap[course.studentName]) {
                    grade = window.studentMap[course.studentName].grade || '';
                } else {
                    grade = course.grade || '';
                }
                const hours = course.duration / 60;
                if (course.type === 'trial') {
                    salary = 39.9;
                } else if (course.type === 'converted') {
                    salary = 99.9;
                } else if (course.type === 'formal') {
                    let hourlyRate = 50;
                    switch (grade) {
                        case 'å°å­¦': hourlyRate = 40; break;
                        case 'åˆä¸­': hourlyRate = 50; break;
                        case 'é«˜ä¸­': hourlyRate = 60; break;
                    }
                    salary = (hourlyRate * hours);
                }
                // å†™å…¥å·²å®Œæˆè¯¾ç¨‹
                const completedCourse = {
                    ...course,
                    completedTime: new Date().toLocaleString('zh-CN'),
                    status: 'completed',
                    salary: salary.toFixed(1),
                    grade: grade,
                    phone: course.phone || (window.studentMap && window.studentMap[course.studentName] ? window.studentMap[course.studentName].phone : '')
                };
                firebase.database().ref('completed').push(completedCourse);
                // ä»scheduleä¸­åˆ é™¤
                firebase.database().ref('schedule/' + courseId).remove();
                showNotification('è¯¾ç¨‹å·²æ ‡è®°ä¸ºå®Œæˆï¼', 'success');
            }
        }
    </script>
</body>
</html> 